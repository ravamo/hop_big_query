<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HopClientEnvironment.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Hop Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.hop.core</a> &gt; <span class="el_source">HopClientEnvironment.java</span></div><h1>HopClientEnvironment.java</h1><pre class="source lang-java linenums">/*! ******************************************************************************
 *
 * Hop : The Hop Orchestration Platform
 *
 * http://www.project-hop.org
 *
 *******************************************************************************
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 ******************************************************************************/

package org.apache.hop.core;

import org.apache.hop.core.database.DatabasePluginType;
import org.apache.hop.core.encryption.Encr;
import org.apache.hop.core.encryption.TwoWayPasswordEncoderPluginType;
import org.apache.hop.core.exception.HopException;
import org.apache.hop.core.exception.HopPluginException;
import org.apache.hop.core.extension.ExtensionPointPluginType;
import org.apache.hop.core.logging.ConsoleLoggingEventListener;
import org.apache.hop.core.logging.HopLogStore;
import org.apache.hop.core.logging.ILoggingPlugin;
import org.apache.hop.core.logging.LoggingPluginType;
import org.apache.hop.core.logging.Slf4jLoggingEventListener;
import org.apache.hop.core.plugins.IPlugin;
import org.apache.hop.core.plugins.IPluginType;
import org.apache.hop.core.plugins.PluginRegistry;
import org.apache.hop.core.row.value.ValueMetaPluginType;
import org.apache.hop.core.util.EnvUtil;
import org.apache.hop.core.vfs.plugin.VfsPluginType;

import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * This singleton is responsible for initializing the Hop client environment and remembering if it is initialized.
 * More specifically it loads client plugins like value meta plugins and other core Hop functionality.
 *
 * @author matt
 */
<span class="fc" id="L57">public class HopClientEnvironment {</span>
  /**
   * For i18n purposes, needed by Translator!!
   */
<span class="fc" id="L61">  private static Class&lt;?&gt; PKG = Const.class;</span>

<span class="fc" id="L63">  private static HopClientEnvironment instance = null;</span>

  private static Boolean initialized;

<span class="nc" id="L67">  public enum ClientType {</span>
<span class="nc" id="L68">    HOP_GUI, CLI, SERVER, OTHER;</span>

    public String getID() {
<span class="nc bnc" id="L71" title="All 2 branches missed.">      if ( this != OTHER ) {</span>
<span class="nc" id="L72">        return this.name();</span>
      }
<span class="nc" id="L74">      return instance.clientID;</span>
    }
  }

  private ClientType client;
  // used when type is OTHER
<span class="fc" id="L80">  private String clientID = null;</span>


  public static synchronized void init() throws HopException {
<span class="fc" id="L84">    init( Arrays.asList(</span>
<span class="fc" id="L85">      LoggingPluginType.getInstance(),</span>
<span class="fc" id="L86">      ValueMetaPluginType.getInstance(),</span>
<span class="fc" id="L87">      DatabasePluginType.getInstance(),</span>
<span class="fc" id="L88">      ExtensionPointPluginType.getInstance(),</span>
<span class="fc" id="L89">      TwoWayPasswordEncoderPluginType.getInstance(),</span>
<span class="fc" id="L90">      VfsPluginType.getInstance()</span>
      )
    );
<span class="fc" id="L93">  }</span>

  public static synchronized void init( List&lt;IPluginType&gt; pluginsToLoad ) throws HopException {
<span class="fc bfc" id="L96" title="All 2 branches covered.">    if ( initialized != null ) {</span>
<span class="fc" id="L97">      return;</span>
    }

<span class="fc bfc" id="L100" title="All 2 branches covered.">    if ( HopClientEnvironment.instance == null ) {</span>
<span class="fc" id="L101">      HopClientEnvironment.instance = new HopClientEnvironment();</span>
    }

    // Check the Hop Configuration backend
    //


    // Initialize the logging back-end.
    //
<span class="fc" id="L110">    HopLogStore.init();</span>

    // Add console output so that folks see what's going on...
    //
<span class="fc bfc" id="L114" title="All 2 branches covered.">    if ( !&quot;Y&quot;.equalsIgnoreCase( System.getProperty( Const.HOP_DISABLE_CONSOLE_LOGGING, &quot;N&quot; ) ) ) {</span>
<span class="fc" id="L115">      HopLogStore.getAppender().addLoggingEventListener( new ConsoleLoggingEventListener() );</span>
    }
<span class="fc" id="L117">    HopLogStore.getAppender().addLoggingEventListener( new Slf4jLoggingEventListener() );</span>

    // Load plugins
    //
<span class="fc" id="L121">    pluginsToLoad.forEach( PluginRegistry::addPluginType );</span>
<span class="fc" id="L122">    PluginRegistry.init();</span>

<span class="fc" id="L124">    List&lt;IPlugin&gt; logginPlugins = PluginRegistry.getInstance().getPlugins( LoggingPluginType.class );</span>
<span class="fc" id="L125">    initLogginPlugins( logginPlugins );</span>

<span class="fc" id="L127">    String passwordEncoderPluginID = Const.NVL( EnvUtil.getSystemProperty( Const.HOP_PASSWORD_ENCODER_PLUGIN ), &quot;Hop&quot; );</span>

<span class="fc" id="L129">    Encr.init( passwordEncoderPluginID );</span>

<span class="fc" id="L131">    initialized = new Boolean( true );</span>
<span class="fc" id="L132">  }</span>

  /**
   * Get all declared fields from the given class, also the ones from all super classes
   *
   * @param parentClass
   * @return A unique list of fields.
   */
  protected static final List&lt;Field&gt; findDeclaredFields( Class&lt;?&gt; parentClass ) {
<span class="nc" id="L141">    Set&lt;Field&gt; fields = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L143" title="All 2 branches missed.">    for ( Field field : parentClass.getDeclaredFields() ) {</span>
<span class="nc" id="L144">      fields.add( field );</span>
    }
<span class="nc" id="L146">    Class&lt;?&gt; superClass = parentClass.getSuperclass();</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">    while ( superClass != null ) {</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">      for ( Field field : superClass.getDeclaredFields() ) {</span>
<span class="nc" id="L149">        fields.add( field );</span>
      }

<span class="nc" id="L152">      superClass = superClass.getSuperclass();</span>
    }

<span class="nc" id="L155">    return new ArrayList&lt;&gt;( fields );</span>
  }

  /**
   * Get all declared methods from the given class, also the ones from all super classes
   *
   * @param parentClass
   * @return A unique list of methods.
   */
  protected static final List&lt;Method&gt; findDeclaredMethods( Class&lt;?&gt; parentClass ) {
<span class="nc" id="L165">    Set&lt;Method&gt; methods = new HashSet&lt;&gt;();</span>

<span class="nc bnc" id="L167" title="All 2 branches missed.">    for ( Method method : parentClass.getDeclaredMethods() ) {</span>
<span class="nc" id="L168">      methods.add( method );</span>
    }
<span class="nc" id="L170">    Class&lt;?&gt; superClass = parentClass.getSuperclass();</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">    while ( superClass != null ) {</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">      for ( Method method : superClass.getDeclaredMethods() ) {</span>
<span class="nc" id="L173">        methods.add( method );</span>
      }

<span class="nc" id="L176">      superClass = superClass.getSuperclass();</span>
    }

<span class="nc" id="L179">    return new ArrayList&lt;&gt;( methods );</span>
  }

  public static boolean isInitialized() {
<span class="nc bnc" id="L183" title="All 2 branches missed.">    return initialized != null;</span>
  }

  private static void initLogginPlugins( List&lt;IPlugin&gt; logginPlugins ) throws HopPluginException {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">    for ( IPlugin plugin : logginPlugins ) {</span>
<span class="nc" id="L188">      ILoggingPlugin loggingPlugin = (ILoggingPlugin) PluginRegistry.getInstance().loadClass( plugin );</span>
<span class="nc" id="L189">      loggingPlugin.init();</span>
<span class="nc" id="L190">    }</span>
<span class="fc" id="L191">  }</span>


  public void setClient( ClientType client ) {
<span class="nc" id="L195">    this.client = client;</span>
<span class="nc" id="L196">  }</span>

  /**
   * Set the Client ID which has significance when the ClientType == OTHER
   *
   * @param id
   */
  public void setClientID( String id ) {
<span class="nc" id="L204">    this.clientID = id;</span>
<span class="nc" id="L205">  }</span>

  public ClientType getClient() {
<span class="nc" id="L208">    return this.client;</span>
  }

  /**
   * Return this singleton. Create it if it hasn't been.
   *
   * @return
   */
  public static HopClientEnvironment getInstance() {

<span class="nc bnc" id="L218" title="All 2 branches missed.">    if ( HopClientEnvironment.instance == null ) {</span>
<span class="nc" id="L219">      HopClientEnvironment.instance = new HopClientEnvironment();</span>
    }

<span class="nc" id="L222">    return HopClientEnvironment.instance;</span>
  }

  public static void reset() {
<span class="fc bfc" id="L226" title="All 2 branches covered.">    if ( HopLogStore.isInitialized() ) {</span>
<span class="fc" id="L227">      HopLogStore.getInstance().reset();</span>
    }
<span class="fc" id="L229">    PluginRegistry.getInstance().reset();</span>
<span class="fc" id="L230">    initialized = null;</span>
<span class="fc" id="L231">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>