<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Hop Core</a> &gt; <a href="index.source.html" class="el_package">org.apache.hop.core</a> &gt; <span class="el_source">DbCache.java</span></div><h1>DbCache.java</h1><pre class="source lang-java linenums">/*! ******************************************************************************
 *
 * Hop : The Hop Orchestration Platform
 *
 * http://www.project-hop.org
 *
 *******************************************************************************
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with
 * the License. You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 ******************************************************************************/

package org.apache.hop.core;

import org.apache.hop.core.exception.HopEofException;
import org.apache.hop.core.exception.HopFileException;
import org.apache.hop.core.logging.ILogChannel;
import org.apache.hop.core.logging.LogChannel;
import org.apache.hop.core.row.IRowMeta;
import org.apache.hop.core.row.RowMeta;

import java.io.BufferedOutputStream;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.util.Enumeration;
import java.util.Hashtable;

/**
 * This class caches database queries so that the same query doesn't get called twice. Queries are often launched to the
 * databases to get information on tables etc.
 *
 * @author Matt
 * @since 15-01-04
 */
public class DbCache {
  private static DbCache dbCache;

  private Hashtable&lt;DbCacheEntry, IRowMeta&gt; cache;
  private boolean usecache;

  private ILogChannel log;

  public void setActive() {
<span class="fc" id="L57">    setActive( true );</span>
<span class="fc" id="L58">  }</span>

  public void setInactive() {
<span class="nc" id="L61">    setActive( false );</span>
<span class="nc" id="L62">  }</span>

  public void setActive( boolean act ) {
<span class="fc" id="L65">    usecache = act;</span>
<span class="fc" id="L66">  }</span>

  public boolean isActive() {
<span class="nc" id="L69">    return usecache;</span>
  }

  public void put( DbCacheEntry entry, IRowMeta fields ) {
<span class="nc bnc" id="L73" title="All 2 branches missed.">    if ( !usecache ) {</span>
<span class="nc" id="L74">      return;</span>
    }

<span class="nc" id="L77">    IRowMeta copy = fields.clone();</span>
<span class="nc" id="L78">    cache.put( entry, copy );</span>
<span class="nc" id="L79">  }</span>

  /**
   * Get the fields as a row generated by a database cache entry
   *
   * @param entry the entry to look for
   * @return the fields as a row generated by a database cache entry
   */
  public IRowMeta get( DbCacheEntry entry ) {
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">    if ( !usecache ) {</span>
<span class="nc" id="L89">      return null;</span>
    }

<span class="fc" id="L92">    IRowMeta fields = cache.get( entry );</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">    if ( fields != null ) {</span>
<span class="nc" id="L94">      fields = fields.clone(); // Copy it again!</span>
    }

<span class="fc" id="L97">    return fields;</span>
  }

  public int size() {
<span class="nc" id="L101">    return cache.size();</span>
  }

  /**
   * Clear out all entries of database with a certain name
   *
   * @param dbname The name of the database for which we want to clear the cache or null if we want to clear it all.
   */
  public void clear( String dbname ) {
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">    if ( dbname == null ) {</span>
<span class="fc" id="L111">      cache = new Hashtable&lt;DbCacheEntry, IRowMeta&gt;();</span>
<span class="fc" id="L112">      setActive();</span>
    } else {
<span class="nc" id="L114">      Enumeration&lt;DbCacheEntry&gt; keys = cache.keys();</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">      while ( keys.hasMoreElements() ) {</span>
<span class="nc" id="L116">        DbCacheEntry entry = keys.nextElement();</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">        if ( entry.sameDB( dbname ) ) {</span>
          // Same name: remove it!
<span class="nc" id="L119">          cache.remove( entry );</span>
        }
<span class="nc" id="L121">      }</span>
    }
<span class="fc" id="L123">  }</span>

  public String getFilename() {
<span class="fc" id="L126">    return Const.HOP_AUDIT_FOLDER + Const.FILE_SEPARATOR + &quot;db.cache&quot;;</span>
  }

<span class="fc" id="L129">  private DbCache() throws HopFileException {</span>
    try {
<span class="fc" id="L131">      clear( null );</span>

      // Serialization support for the DB cache
      //
<span class="fc" id="L135">      log = new LogChannel( &quot;DbCache&quot; );</span>

<span class="fc" id="L137">      String filename = getFilename();</span>
<span class="fc" id="L138">      File file = new File( filename );</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">      if ( file.canRead() ) {</span>
<span class="nc" id="L140">        log.logDetailed( &quot;Loading database cache from file: [&quot; + filename + &quot;]&quot; );</span>

<span class="nc" id="L142">        try ( FileInputStream fis = new FileInputStream( file ); DataInputStream dis = new DataInputStream( fis ) ) {</span>
<span class="nc" id="L143">          int counter = 0;</span>
          try {
            while ( true ) {
<span class="nc" id="L146">              DbCacheEntry entry = new DbCacheEntry( dis );</span>
<span class="nc" id="L147">              IRowMeta row = new RowMeta( dis );</span>
<span class="nc" id="L148">              cache.put( entry, row );</span>
<span class="nc" id="L149">              counter++;</span>
<span class="nc" id="L150">            }</span>
<span class="nc" id="L151">          } catch ( HopEofException eof ) {</span>
<span class="nc" id="L152">            log.logDetailed( &quot;We read &quot; + counter + &quot; cached rows from the database cache!&quot; );</span>
          }
<span class="nc" id="L154">        } catch ( Exception e ) {</span>
<span class="nc" id="L155">          throw new Exception( e );</span>
<span class="nc" id="L156">        }</span>
      } else {
<span class="fc" id="L158">        log.logDetailed( &quot;The database cache doesn't exist yet.&quot; );</span>
      }
<span class="nc" id="L160">    } catch ( Exception e ) {</span>
<span class="nc" id="L161">      throw new HopFileException( &quot;Couldn't read the database cache&quot;, e );</span>
<span class="fc" id="L162">    }</span>
<span class="fc" id="L163">  }</span>

  public void saveCache() throws HopFileException {
    try {
      // Serialization support for the DB cache
      //
<span class="nc" id="L169">      String filename = getFilename();</span>
<span class="nc" id="L170">      File file = new File( filename );</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">      if ( !file.exists() || file.canWrite() ) {</span>

<span class="nc" id="L173">        try ( FileOutputStream fos = new FileOutputStream( file ); DataOutputStream dos = new DataOutputStream( new BufferedOutputStream( fos, 10000 ) ) ) {</span>

<span class="nc" id="L175">          int counter = 0;</span>

<span class="nc" id="L177">          Enumeration&lt;DbCacheEntry&gt; keys = cache.keys();</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">          while ( keys.hasMoreElements() ) {</span>
            // Save the database cache entry
<span class="nc" id="L180">            DbCacheEntry entry = keys.nextElement();</span>
<span class="nc" id="L181">            entry.write( dos );</span>

            // Save the corresponding row as well.
<span class="nc" id="L184">            IRowMeta rowMeta = get( entry );</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            if ( rowMeta != null ) {</span>
<span class="nc" id="L186">              rowMeta.writeMeta( dos );</span>
<span class="nc" id="L187">              counter++;</span>
            } else {
<span class="nc" id="L189">              throw new HopFileException( &quot;The database cache contains an empty row. We can't save this!&quot; );</span>
            }
<span class="nc" id="L191">          }</span>

<span class="nc" id="L193">          log.logDetailed( &quot;We wrote &quot; + counter + &quot; cached rows to the database cache!&quot; );</span>
<span class="nc" id="L194">        } catch ( Exception e ) {</span>
<span class="nc" id="L195">          throw new Exception( e );</span>
<span class="nc" id="L196">        }</span>
      } else {
<span class="nc" id="L198">        throw new HopFileException( &quot;We can't write to the cache file: &quot; + filename );</span>
      }
<span class="nc" id="L200">    } catch ( Exception e ) {</span>
<span class="nc" id="L201">      throw new HopFileException( &quot;Couldn't write to the database cache&quot;, e );</span>
<span class="nc" id="L202">    }</span>
<span class="nc" id="L203">  }</span>

  /**
   * Create the database cache instance by loading it from disk
   *
   * @return the database cache instance.
   * @throws HopFileException
   */
  public static final DbCache getInstance() {
<span class="fc bfc" id="L212" title="All 2 branches covered.">    if ( dbCache != null ) {</span>
<span class="fc" id="L213">      return dbCache;</span>
    }
    try {
<span class="fc" id="L216">      dbCache = new DbCache();</span>
<span class="nc" id="L217">    } catch ( HopFileException kfe ) {</span>
<span class="nc" id="L218">      throw new RuntimeException( &quot;Unable to create the database cache: &quot; + kfe.getMessage() );</span>
<span class="fc" id="L219">    }</span>
<span class="fc" id="L220">    return dbCache;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>